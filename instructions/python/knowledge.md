# üêç Python Backend: –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Django-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Bitrix24

## üìã –û–±–∑–æ—Ä

- Python backend –∂–∏–≤—ë—Ç –≤ `backends/python/api` –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ Django. FastAPI –≤ –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `main` –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç REST-—Ç–æ—á–∫–∏ `/api*`, —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, —Ä–∞–±–æ—Ç—É —Å –º–æ–¥–µ–ª—è–º–∏ –∏ –Ω–∞–±–æ—Ä —Å–ª—É–∂–µ–±–Ω—ã—Ö –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤.
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç OAuth Bitrix24 (—á–µ—Ä–µ–∑ `b24pysdk`) –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ JWT, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø—É—Å–∫–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `bitrix24account`.
- –ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

---

## ‚öôÔ∏è –°—Ç–µ–∫ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Django** ‚Äî –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π middleware, ORM, admin –∏ —Ç–æ—á–∫–∞–º–∏ –≤—Ö–æ–¥–∞ WSGI/ASGI.
- **b24pysdk==0.2.3a1** ‚Äî SDK –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å Bitrix24 (OAuth, REST, —Å–æ–±—ã—Ç–∏—è).
- **PostgreSQL + psycopg2-binary** ‚Äî –ë–î –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Django.
- **PyJWT** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö JWT-—Ç–æ–∫–µ–Ω–æ–≤.
- **django-cors-headers** ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏ CORS/X-Frame –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Bitrix24.
- **environs** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ `.env` / –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
- **gunicorn** ‚Äî WSGI-—Å–µ—Ä–≤–µ—Ä –≤ –ø—Ä–æ–¥-—Ä–µ–∂–∏–º–µ (—Å–º. `Dockerfile`).

### requirements.txt (`backends/python/api/requirements.txt`)
```txt
Django
psycopg2-binary
django-cors-headers
PyJWT
gunicorn
environs
b24pysdk==0.2.3a1
```

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```text
backends/python/api/
‚îú‚îÄ‚îÄ asgi.py / wsgi.py          # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ Django
‚îú‚îÄ‚îÄ config.py                  # dataclass Config + –∑–∞–≥—Ä—É–∑–∫–∞ .env
‚îú‚îÄ‚îÄ Dockerfile                 # multi-stage (dev/prod)
‚îú‚îÄ‚îÄ manage.py                  # CLI Django
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ settings.py / urls.py      # –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
‚îî‚îÄ‚îÄ main/
    ‚îú‚îÄ‚îÄ admin.py               # —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
    ‚îú‚îÄ‚îÄ models.py              # Bitrix24Account, ApplicationInstallation
    ‚îú‚îÄ‚îÄ urls.py                # /api*, /api/health –∏ —Ç.–¥.
    ‚îú‚îÄ‚îÄ utils/
    ‚îÇ   ‚îú‚îÄ‚îÄ authorized_request.py
    ‚îÇ   ‚îî‚îÄ‚îÄ decorators/
    ‚îÇ       ‚îú‚îÄ‚îÄ auth_required.py
    ‚îÇ       ‚îú‚îÄ‚îÄ collect_request_data.py
    ‚îÇ       ‚îî‚îÄ‚îÄ log_errors.py
    ‚îî‚îÄ‚îÄ views.py               # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
```

> –¢–∞–±–ª–∏—Ü—ã `bitrix24account` –∏ `application_installation` –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ `managed = False`, –ø–æ—ç—Ç–æ–º—É –∏—Ö —Å—Ö–µ–º–æ–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å (PHP backend). Django —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏.

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### `config.py`
`Config` –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ `environs.Env` –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ —Å–∏–Ω–≥–ª—Ç–æ–Ω `config`. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ (–≤–∫–ª—é—á–∞—è `settings.py` –∏ –º–æ–¥–µ–ª–∏) –±–µ—Ä—É—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Ç—Å—é–¥–∞.

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                      | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-------------------|--------------------------------------------------|-----------------------|
| `BUILD_TARGET`    | `dev`/`production`; —É–ø—Ä–∞–≤–ª—è–µ—Ç `DEBUG`            | `dev`                 |
| `DB_NAME`         | –∏–º—è –ë–î                                          | `appdb`               |
| `DB_USER`         | –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î                                 | `appuser`             |
| `DB_PASSWORD`     | –ø–∞—Ä–æ–ª—å –ë–î                                       | `apppass`             |
| `DB_HOST` / `PORT`| –∞–¥—Ä–µ—Å PostgreSQL (`database`/`5432` –≤ Docker)    | `database` / `5432`   |
| `CLOUDPUB_TOKEN`  | —Ç–æ–∫–µ–Ω CloudPub                                  | –ø—É—Å—Ç–æ                 |
| `JWT_SECRET`      | –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –∫–∞–∫ `SECRET_KEY` Django           | `default_jwt_secret`  |
| `JWT_ALGORITHM`   | –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏ JWT                            | `HS256`               |
| `CLIENT_ID`       | OAuth client ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Bitrix24             | `client_id`           |
| `CLIENT_SECRET`   | OAuth client secret                             | `client_secret`       |
| `VIRTUAL_HOST`    | –≤–Ω–µ—à–Ω–∏–π URL; –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `CSRF_TRUSTED_ORIGINS`   | `app_base_url`        |

–î–æ–ø. –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ENABLE_RABBITMQ`) —á–∏—Ç–∞—é—Ç—Å—è Makefile'–æ–º –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ docker compose.

### `settings.py`
- `SECRET_KEY = config.jwt_secret`, `DEBUG` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è `BUILD_TARGET`.
- `ALLOWED_HOSTS` –∏ `CSRF_TRUSTED_ORIGINS` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏–∑ `VIRTUAL_HOST`, –∑–∞–ø–∞—Å–Ω—ã–µ –¥–æ–º–µ–Ω—ã ‚Äî `localhost`, `api-python`.
- `INSTALLED_APPS` –≤–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä Django + `corsheaders` + `main`.
- `MIDDLEWARE` –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `CorsMiddleware`, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ—Å—Ç–∞–≤–ª—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏.
- `DATABASES['default']` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `django.db.backends.postgresql_psycopg2` –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `Config`.
- `CORS_ALLOW_ALL_ORIGINS = True` ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è dev, –Ω–æ –≤ –ø—Ä–æ–¥–µ –ª—É—á—à–µ –∑–∞–¥–∞–≤–∞—Ç—å –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫.

```python
INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "corsheaders",
    "main",
]
```

---

## üöÄ –ó–∞–ø—É—Å–∫ –∏ –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### Docker / Makefile
- `make dev-python` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π, –ø–æ–¥–Ω–∏–º–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏ `frontend,python,cloudpub` (+ `queue`, –µ—Å–ª–∏ –≤ `.env` `ENABLE_RABBITMQ=1`).
- `make prod-python` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ Python backend –≤ production-—Ä–µ–∂–∏–º–µ.

### –ë–µ–∑ Docker
```bash
cd backends/python/api
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
python manage.py migrate --noinput
python manage.py runserver 0.0.0.0:8000
```
–ö–æ–Ω–≤–µ–π–µ—Ä –≤ `Dockerfile` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `makemigrations`, `migrate` –∏ `createsuperuser --noinput`, –Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é.

### Dockerfile (–∫—Ä–∞—Ç–∫–æ)
- **base**: `python:3.11-slim`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `postgresql-client` –∏ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
- **dev**: –º–æ–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–µ–∫—Ç –∫–∞–∫ volume –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `runserver` –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π.
- **prod**: –∫–æ–ø–∏—Ä—É–µ—Ç –∫–æ–¥ –≤ –æ–±—Ä–∞–∑ –∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç Gunicorn (`gunicorn wsgi:application --bind 0.0.0.0:8000`).

---

## üß± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `main`

### URL-–º–∞—Ä—à—Ä—É—Ç—ã (`main/urls.py`)
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å             | View        | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------------------|-------------|----------|
| GET   | `/api`           | `root`      | –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç ¬´Python Backend is running¬ª|
| GET   | `/api/health`    | `health`    | Health-check —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∏ timestamp |
| GET   | `/api/enum`      | `get_enum`  | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –æ–ø—Ü–∏–π |
| GET   | `/api/list`      | `get_list`  | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ |
| POST  | `/api/install`   | `install`   | –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `ApplicationInstallation` |
| POST  | `/api/getToken`  | `get_token` | –í—ã–¥–∞—á–∞ –Ω–æ–≤–æ–≥–æ JWT |

–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–º–µ—á–µ–Ω—ã `@xframe_options_exempt`, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤ iframe Bitrix24.

### Views (`main/views.py`)
- –ü—Ä–æ—Å—Ç—ã–µ GET-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Å–ª—É–∂–∞—Ç —à–∞–±–ª–æ–Ω–æ–º ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –∏—Ö –ø–æ–¥ –Ω—É–∂–¥—ã –ø—Ä–æ–µ–∫—Ç–∞.
- `install` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `ApplicationInstallation` –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞ Bitrix24, –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª—è –∏–∑ `request.bitrix24_account`.
- `get_token` –≤—ã–∑—ã–≤–∞–µ—Ç `Bitrix24Account.create_jwt_token()` (TTL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60 –º–∏–Ω—É—Ç).
- –í—Å–µ view –¥–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã `@auth_required` –∏ `@log_errors`, –ø–æ—ç—Ç–æ–º—É –ª—é–±—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ JSON —Å –∫–æ–¥–æ–º 500 –∏ –ø–∏—à—É—Ç—Å—è –≤ –ª–æ–≥–∏.

### –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –∏ `AuthorizedRequest`
- `AuthorizedRequest` –¥–æ–ø–æ–ª–Ω—è–µ—Ç `HttpRequest` –ø–æ–ª–µ–º `bitrix24_account` –¥–ª—è —É–¥–æ–±–Ω—ã—Ö type hints.
- `collect_request_data` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç JSON-—Ç–µ–ª–æ, GET –∏ POST-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `request.data`, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—è —Å–ø–∏—Å–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π.
- `auth_required`:
  1. –ò—â–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <jwt>`.
  2. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ JWT –≤—ã–∑—ã–≤–∞–µ—Ç `Bitrix24Account.get_from_jwt_token()` –∏ –∫–ª–∞–¥—ë—Ç –æ–±—ä–µ–∫—Ç –≤ `request.bitrix24_account`.
  3. –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç `OAuthPlacementData` –∏–∑ `request.data` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `Bitrix24Account.update_or_create_from_oauth_placement_data()` (—á–µ—Ä–µ–∑ SDK). –û–±—ä–µ–∫—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏ —Ç–∞–∫–∂–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `request.bitrix24_account`.
  4. –í—Å–µ –æ—à–∏–±–∫–∏ (`DoesNotExist`, `ExpiredSignature`, `BitrixValidationError`) –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è –≤ JSON-–æ—Ç–≤–µ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ 400/401.
- `log_errors("name")` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –ø–∏—à–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `logging`.

```python
@log_errors("get_token")
@auth_required
def get_token(request: AuthorizedRequest):
    return JsonResponse({"token": request.bitrix24_account.create_jwt_token()})
```

### –ú–æ–¥–µ–ª–∏ (`main/models.py`)
- `Bitrix24Account` –Ω–∞—Å–ª–µ–¥—É–µ—Ç `AbstractBitrixToken` –∏ —Å–≤—è–∑–∞–Ω —Å —Ç–∞–±–ª–∏—Ü–µ–π `bitrix24account` (UUID PK). –í–∞–∂–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
  - `bitrix_app` ‚Äî –∫–ª–∞—Å—Å-—Å–≤–æ–π—Å—Ç–≤–æ, —Å—Ç—Ä–æ—è—â–µ–µ `BitrixApp` –∏–∑ `CLIENT_ID/CLIENT_SECRET`.
  - `client` ‚Äî –≤—Ä–∞–ø–ø–µ—Ä –Ω–∞–¥ `b24pysdk.Client` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å REST API.
  - `create_jwt_token(minutes=60)` / `get_from_jwt_token` ‚Äî –≤—ã–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ PyJWT.
  - `update_or_create_from_oauth_placement_data` ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∏–∑ `auth_required`, —Å–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –ø–æ –¥–∞–Ω–Ω—ã–º OAuth.
  - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (`portal_domain_changed_signal`, `oauth_token_renewed_signal`) —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç –ø–æ–ª—è –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö Bitrix24.
- `ApplicationInstallation` —Ö—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç–∞–ª–µ –∏ —Å–≤—è–∑–∞–Ω `OneToOne` —Å `Bitrix24Account`.

### –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (`main/admin.py`)
- –û–±–µ –º–æ–¥–µ–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º `list_display`; –ø–æ–ª–µ `id` —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è.
- –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è dev —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∫–æ–º–∞–Ω–¥–∞ `createsuperuser --noinput` –≤ Docker). URL –∞–¥–º–∏–Ω–∫–∏ ‚Äî `/api/admin/`.

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –≤—ã–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–æ–≤
1. Bitrix24 –≤—ã–∑—ã–≤–∞–µ—Ç backend –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç payload OAuth placement.
2. `collect_request_data` –∫–ª–∞–¥—ë—Ç JSON + query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `request.data`.
3. `auth_required` –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç payload –≤ `OAuthPlacementData` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `Bitrix24Account.update_or_create_from_oauth_placement_data()` (SDK –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ç—è–Ω–µ—Ç `app_info`).
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
   - `install` —Å–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç `ApplicationInstallation`.
   - `get_token` –≤—ã–ø—É—Å–∫–∞–µ—Ç JWT –∏ –æ—Ç–¥–∞—ë—Ç –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.
5. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç JWT –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization` –ø—Ä–∏ –≤—Å–µ—Ö –±—É–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö; `auth_required` –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –∏ –Ω–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ API Bitrix24.

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –•—Ä–∞–Ω–∏—Ç–µ `JWT_SECRET`, OAuth-–∫–ª—é—á–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î –≤ `.env` / —Å–µ–∫—Ä–µ—Ç–∞—Ö CI/CD. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ JWT (TTL –∑–∞–¥–∞—ë—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `minutes` –≤ `create_jwt_token`). –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –∑–∞–Ω–æ–≤–æ –≤—ã–∑–≤–∞—Ç—å `/api/getToken` –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å OAuth-–ø–æ—Ç–æ–∫.
- `CSRF_TRUSTED_ORIGINS` —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–æ–º–µ–Ω–∞–º–∏ Bitrix24 –ª—É—á—à–µ —è–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –∏—Ö –≤ `VIRTUAL_HOST` –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É.
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–∞–¥–∞–π—Ç–µ `CORS_ALLOWED_ORIGINS` / `CORS_ALLOW_CREDENTIALS`, —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–±–æ—Ä –ª–æ–≥–æ–≤ (Sentry/ELK). –°–µ–π—á–∞—Å `log_errors` –≤—ã–≤–æ–¥–∏—Ç –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `logging`.

---

## üì¶ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ
- Docker-–æ–±—Ä–∞–∑ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ `python:3.11-slim`. –°–ª–µ–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤ `requirements.txt` –Ω–µ –±—ã–ª–æ –ª–∏—à–Ω–∏—Ö –ø–∞–∫–µ—Ç–æ–≤, –∏–Ω–∞—á–µ –æ–±—Ä–∞–∑ —Ä–∞–∑—Ä–∞—Å—Ç—ë—Ç—Å—è.
- –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ `.env`: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î, OAuth, JWT, `VIRTUAL_HOST`.
- `docker compose --env-file .env up --build` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ (`COMPOSE_PROFILES=python` –¥–ª—è –ø—Ä–æ–¥-—Ä–µ–∂–∏–º–∞).
- –í Kubernetes/–∞–Ω–∞–ª–æ–≥–∞—Ö –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ `python manage.py migrate` –æ—Ç–¥–µ–ª—å–Ω—ã–º job, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –≥–æ–Ω–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `pytest` + `pytest-django` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `manage.py test`.
- –ü–æ–∫—Ä–æ–π—Ç–µ:
  - `auth_required` (–≤–µ—Ç–∫–∏ JWT vs OAuth payload, –æ—à–∏–±–∫–∏ PyJWT, BitrixValidationError).
  - `Bitrix24Account.create_jwt_token` / `get_from_jwt_token` (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–µ–∫—Ä–µ—Ç, –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞).
  - Views `install`/`get_token` —Å mock'–∞–º–∏ –º–æ–¥–µ–ª–µ–π –∏ SDK.
- –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `django.test.Client` –∏ monkeypatch `b24pysdk`.

---

## üêû –¢—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥
- **`Invalid JWT token`** ‚Äî —Å–µ–∫—Ä–µ—Ç –≤ `.env` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ø—Ä–∏ –≤—ã–¥–∞—á–µ —Ç–æ–∫–µ–Ω–∞. –ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç–µ JWT —á–µ—Ä–µ–∑ `/api/getToken`.
- **`JWT token has expired`** ‚Äî —É–≤–µ–ª–∏—á—å—Ç–µ TTL –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ—å—Ç–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ.
- **–û—à–∏–±–∫–∏ CSRF/iframe** ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `VIRTUAL_HOST` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞ –ø–æ—Ä—Ç–∞–ª–∞.
- **`BitrixValidationError`** –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ payload –µ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (`domain`, `member_id`, `auth[access_token]`, –∏ —Ç.–¥.).
- **–ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î** ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `database` –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ `DB_HOST`.

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- `instructions/python/bitrix24-python-sdk.md` ‚Äî –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å SDK –∏ –ø—Ä–∏–º–µ—Ä—ã REST-–∑–∞–ø—Ä–æ—Å–æ–≤.
- `instructions/python/code-review.md` ‚Äî —á–µ–∫-–ª–∏—Å—Ç —Ä–µ–≤—å—é Python-–∫–æ–¥–∞.
- `instructions/queues/python.md` ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ (Celery/RabbitMQ).
- `README.md` –∏ `makefile` –≤ –∫–æ—Ä–Ω–µ –æ–ø–∏—Å—ã–≤–∞—é—Ç –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É docker-–ø—Ä–æ—Ñ–∏–ª–µ–π –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞–ø—É—Å–∫–∞ —Å—Ç–µ–Ω–¥–∞.

*–û–±–Ω–æ–≤–ª–µ–Ω–æ: 5 –¥–µ–∫–∞–±—Ä—è 2025 –≥–æ–¥–∞.*
